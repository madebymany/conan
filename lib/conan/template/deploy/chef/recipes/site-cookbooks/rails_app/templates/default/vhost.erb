<VirtualHost *:80>

  ServerName <%= node[:rails_app][:canonical_domain] %>
  <% node[:rails_app][:domain_aliases].each do |a| %>
  ServerAlias <%= a %>
  <% end %>

  DocumentRoot <%= node[:rails_app][:home] %>/current/public

  RailsEnv production

  <Directory "<%= node[:rails_app][:home] %>/current/public">
    Header set Cache-Control "max-age=315360000"
    Options FollowSymLinks
    AllowOverride All
    Order allow,deny
    Allow from all

    <% if node[:htpasswd] %>
    AuthName "Password required"
    AuthType Basic
    AuthUserFile /etc/apache2/htpasswd
    require valid-user
    <% end %>
  </Directory>

  <Directory "<%= node[:rails_app][:home] %>/current/public/system">
    Header set Cache-Control "no-cache"
  </Directory>

  # Rails specific rewrite rules
  RewriteEngine On

  # Check for maintenance file and redirect all requests
  ErrorDocument 503 /system/maintenance.html
  RewriteCond %{DOCUMENT_ROOT}/system/maintenance.html -f
  RewriteCond %{SCRIPT_FILENAME} !^/(system|stylesheets|images|javascripts)
  RewriteRule ^.*$ /system/maintenance.html [R=503,L]

  # Rewrite (some) domains to canonical domain
  <% node[:rails_app][:redirections].each do |domain|
     pattern = domain.sub(/\$$/, "(:.*)?$").gsub(/\./, "\\\\.") %>
  RewriteCond %{HTTP_HOST} <%= pattern %> [NC]
  RewriteRule ^/(.*) http://<%= node[:rails_app][:canonical_domain] %>/$1 [R=301,L]
  <% end %>

  # Deflate
  AddOutputFilterByType DEFLATE text/plain text/html text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript
  BrowserMatch ^Mozilla/4 gzip-only-text/html
  BrowserMatch ^Mozilla/4.0[678] no-gzip
  BrowserMatch \bMSIE !no-gzip !gzip-only-text/html

  # Add any access limit directives here
  <Location />
    Allow from all
  </Location>

</VirtualHost>
